- name: test playbook
  hosts: localhost
  gather_facts: no
  connection: local
  collections:
    - paloaltonetworks.panos
  vars:
     provider_pa:
       ip_address: "{{ ip_address_pa }}"
       username: "{{ username_pa }}"
       password: "{{ password_pa }}"
  # roles:
  #   - role: PaloAltoNetworks.paloaltonetworks
  tasks:
    - name: Retrieve address group object
      panos_address_group:
        provider: '{{ provider_pa }}'
        name: 'Blacklist'
        state: 'gathered'
      register: result
   
   - debug:
       var: result.gathered.static_value
      
    # Create Object
    - name: Update Address Group(s)'
      panos_address_group:
        provider: "{{ provider_pa }}"
        device_group: "{{ item.Device_Group }}"
        name: "{{ item.Name }}"
        description: "{{ item.Description }}"
        static_value: "{{ result.gathered.static_value | reject('in', item.Object) }}"
      loop_control:
        label: '{{ item.name }}'
      loop: "{{ objects }}"
      when:
        - result.gathered.static_value
        - item.Object in result.gathered.static_value
      
    - name: Remove address object
      panos_address_object:
        provider: "{{ provider_pa }}"
        name: "{{ item.name }}"
        state: 'absent'
      loop: "{{ objects }}"

    - name: commit specific device group changes on panorama
      panos_commit_panorama:
        provider: "{{ provider_pa }}"
        device_groups: "{{ device_group }}"
     
    - name: push to multiple devices
      panos_commit_push:
        provider: '{{ provider_pa }}'
        style: 'device group'
        name: '{{ device_group }}'

    - name: wait for commits to finish
      panos_check:
        provider: '{{ provider_pa }}'
        initial_delay: 10
        interval: 5
        timeout: 100
